import{a,j as e,B as o,ap as C,T as i,b1 as re,C as v,bi as ae,d as N,b3 as oe,o as f,O as ne,bj as ie,h as le,N as ce,G as y,D as $,b as U,c as L,w as G,e as V,f as O,bk as de,A as J,J as H,aM as xe,g as he}from"./mui-1d16f996.js";import{r as ue,s as pe,a as ge,b as me,g as K,c as fe,d as be,P as je,e as R,f as q,h as ye,i as F,j as Ce,t as ve}from"./presence-79326ce2.js";import{o as ke}from"./index-41f25fd8.js";import"./dayjs-9d6a636c.js";const Se=({user:t,themeConfig:p})=>{const[n,b]=a.useState([]),[l,u]=a.useState(""),[M,k]=a.useState([]),[c,d]=a.useState(0),[x,h]=a.useState(""),[S,_]=a.useState([]),[Q,z]=a.useState(!0),[j,g]=a.useState({open:!1,message:"",severity:"success"}),[P,w]=a.useState(null),[X,D]=a.useState(!1),[Y,I]=a.useState(!1),A=a.useRef(null),T=a.useRef(null),W=a.useCallback(()=>{var s;(s=A.current)==null||s.scrollIntoView({behavior:"smooth"})},[]);a.useEffect(()=>{ue()},[]),a.useEffect(()=>(z(!0),pe(r=>{if(b(r),z(!1),r.length>n.length&&n.length>0){const m=r[r.length-1];ye(m,t)}})),[t,n.length]),a.useEffect(()=>ge((r,m)=>{k(r),d(m)}),[]),a.useEffect(()=>{_(me(n,x))},[n,x]),a.useEffect(()=>{var r;return K.setCurrentPage("채팅"),localStorage.getItem("hasVisitedChat")||(fe(`${t.displayName??((r=t.email)==null?void 0:r.split("@")[0])}님이 채팅방에 입장했습니다! 👋`),localStorage.setItem("hasVisitedChat","true")),()=>{K.setCurrentPage("")}},[t]),a.useEffect(()=>{W()},[S,W]);const B=async()=>{var r;if(!l.trim())return;const s=await F(t,l);s.success?(u(""),(r=T.current)==null||r.focus()):g({open:!0,message:s.message??"메시지 전송 실패",severity:"error"})},Z=s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),B())},ee=async s=>{const r=await F(t,s,"emoji");r.success||g({open:!0,message:r.message??"이모지 전송 실패",severity:"error"}),w(null)},se=async s=>{const r=await Ce(t,s);g({open:!0,message:r.message??(r.success?"삭제 완료":"삭제 실패"),severity:r.success?"success":"error"})},te=async(s,r)=>{const m=await ve(t,s,r);m.success||g({open:!0,message:m.message??"반응 처리 실패",severity:"error"})},E=be(n);return e.jsxs(o,{sx:{height:"100%",display:"flex",flexDirection:"column"},children:[e.jsx(C,{elevation:2,sx:{p:2,borderRadius:"12px 12px 0 0",background:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)",color:"white"},children:e.jsxs(o,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(i,{variant:"h6",sx:{fontWeight:"bold"},children:"💬 데일리 미니채팅"}),e.jsx(re,{badgeContent:c,color:"success",children:e.jsx(v,{icon:e.jsx(ae,{}),label:`${c}명 온라인`,size:"small",sx:{backgroundColor:"rgba(255,255,255,0.2)",color:"white",cursor:"pointer"},onClick:()=>D(!0)})})]}),e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(N,{size:"small",placeholder:"메시지 검색...",value:x,onChange:s=>h(s.target.value),sx:{backgroundColor:"rgba(255,255,255,0.1)",borderRadius:1,"& .MuiOutlinedInput-root":{color:"white","& fieldset":{borderColor:"rgba(255,255,255,0.3)"},"&:hover fieldset":{borderColor:"rgba(255,255,255,0.5)"},"&.Mui-focused fieldset":{borderColor:"white"}}},InputProps:{startAdornment:e.jsx(oe,{sx:{color:"rgba(255,255,255,0.7)",mr:1}})}}),e.jsx(f,{onClick:()=>I(!0),sx:{color:"white"},children:e.jsx(ne,{})})]})]})}),e.jsxs(o,{sx:{flex:1,overflow:"auto",p:1,backgroundColor:"#f8f9fa",backgroundImage:"linear-gradient(45deg, #f0f2f5 25%, transparent 25%), linear-gradient(-45deg, #f0f2f5 25%, transparent 25%)",backgroundSize:"20px 20px",backgroundPosition:"0 0, 0 10px"},children:[Q?e.jsx(o,{sx:{display:"flex",justifyContent:"center",p:4},children:e.jsx(i,{color:"text.secondary",children:"메시지를 불러오는 중... 💫"})}):S.length===0?e.jsxs(o,{sx:{display:"flex",flexDirection:"column",alignItems:"center",p:4},children:[e.jsx(i,{variant:"h6",color:"text.secondary",gutterBottom:!0,children:x?"검색 결과가 없습니다 🔍":"첫 번째 메시지를 보내보세요! 🚀"}),!x&&e.jsx(i,{color:"text.secondary",children:"다른 사용자들과 실시간으로 소통해보세요 ✨"})]}):S.map((s,r)=>e.jsx(Ee,{message:s,currentUser:t,isOwn:s.userEmail===t.email,onDelete:se,onReaction:te,showAvatar:r===0||S[r-1].userEmail!==s.userEmail},s.id)),e.jsx("div",{ref:A})]}),e.jsx(C,{elevation:3,sx:{p:2,borderRadius:"0 0 12px 12px",backgroundColor:"white"},children:e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(N,{ref:T,fullWidth:!0,multiline:!0,maxRows:3,placeholder:"메시지를 입력하세요... (Shift+Enter로 줄바꿈)",value:l,onChange:s=>u(s.target.value),onKeyPress:Z,variant:"outlined",size:"small",sx:{"& .MuiOutlinedInput-root":{borderRadius:3}}}),e.jsx(f,{onClick:s=>w(s.currentTarget),color:"primary",sx:{backgroundColor:"rgba(25, 118, 210, 0.04)","&:hover":{backgroundColor:"rgba(25, 118, 210, 0.08)"}},children:e.jsx(ie,{})}),e.jsx(f,{onClick:B,disabled:!l.trim(),color:"primary",sx:{backgroundColor:l.trim()?"primary.main":"rgba(0,0,0,0.04)",color:l.trim()?"white":"rgba(0,0,0,0.26)","&:hover":{backgroundColor:l.trim()?"primary.dark":"rgba(0,0,0,0.08)"}},children:e.jsx(le,{})})]})}),e.jsx(ce,{anchorEl:P,open:!!P,onClose:()=>w(null),PaperProps:{sx:{borderRadius:2,boxShadow:"0 8px 32px rgba(0,0,0,0.12)",maxWidth:300}},children:e.jsxs(o,{sx:{p:1},children:[e.jsx(i,{variant:"subtitle2",sx:{px:1,pb:1,color:"text.secondary"},children:"자주 사용하는 이모지"}),e.jsx(y,{container:!0,spacing:.5,children:je.map(s=>e.jsx(y,{item:!0,children:e.jsx(f,{size:"small",onClick:()=>ee(s),sx:{fontSize:"1.2rem","&:hover":{backgroundColor:"rgba(25, 118, 210, 0.08)"}},children:s})},s))})]})}),e.jsxs($,{open:X,onClose:()=>D(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsxs(U,{children:["🌐 온라인 사용자 (",c,"명)"]}),e.jsx(L,{children:M.map(s=>e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:2,p:1,borderRadius:1,"&:hover":{backgroundColor:"rgba(0,0,0,0.04)"}},children:[e.jsx(G,{src:s.photoURL,sx:{width:32,height:32,border:`2px solid ${R(s.email)}`},children:s.displayName.charAt(0)}),e.jsxs(o,{sx:{flex:1},children:[e.jsx(i,{variant:"body2",fontWeight:"medium",children:s.displayName}),e.jsxs(i,{variant:"caption",color:"text.secondary",children:[s.page&&`📍 ${s.page} • `,q(s.lastSeen)]})]}),e.jsx(v,{label:s.status==="online"?"온라인":"자리비움",size:"small",color:s.status==="online"?"success":"default"})]},s.uid))}),e.jsx(V,{children:e.jsx(O,{onClick:()=>D(!1),children:"닫기"})})]}),e.jsxs($,{open:Y,onClose:()=>I(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(U,{children:"⚙️ 채팅 설정"}),e.jsx(L,{children:e.jsxs(o,{sx:{py:2},children:[e.jsx(i,{variant:"h6",gutterBottom:!0,children:"📊 채팅 통계"}),e.jsxs(y,{container:!0,spacing:2,children:[e.jsx(y,{item:!0,xs:6,children:e.jsxs(C,{sx:{p:2,textAlign:"center"},children:[e.jsx(i,{variant:"h4",color:"primary",children:E.totalMessages}),e.jsx(i,{variant:"caption",children:"총 메시지"})]})}),e.jsx(y,{item:!0,xs:6,children:e.jsxs(C,{sx:{p:2,textAlign:"center"},children:[e.jsx(i,{variant:"h4",color:"success.main",children:E.messagesThisHour}),e.jsx(i,{variant:"caption",children:"최근 1시간"})]})})]}),E.topEmojis.length>0&&e.jsxs(o,{sx:{mt:3},children:[e.jsx(i,{variant:"subtitle1",gutterBottom:!0,children:"🏆 인기 이모지"}),e.jsx(o,{sx:{display:"flex",gap:1,flexWrap:"wrap"},children:E.topEmojis.map((s,r)=>e.jsx(v,{label:`${s.emoji} ${s.count}`,size:"small",variant:r===0?"filled":"outlined",color:r===0?"primary":"default"},s.emoji))})]})]})}),e.jsx(V,{children:e.jsx(O,{onClick:()=>I(!1),children:"닫기"})})]}),e.jsx(de,{open:j.open,autoHideDuration:3e3,onClose:()=>g({...j,open:!1}),children:e.jsx(J,{severity:j.severity,onClose:()=>g({...j,open:!1}),children:j.message})})]})},Ee=({message:t,currentUser:p,isOwn:n,onDelete:b,onReaction:l,showAvatar:u})=>{const[M,k]=a.useState(!1);return t.type==="system"?e.jsx(o,{sx:{display:"flex",justifyContent:"center",my:2},children:e.jsx(v,{label:t.content,size:"small",sx:{backgroundColor:"rgba(25, 118, 210, 0.08)",color:"primary.main",fontWeight:"medium"}})}):e.jsxs(o,{sx:{display:"flex",flexDirection:n?"row-reverse":"row",alignItems:"flex-start",gap:1,mb:u?2:.5,px:1},onMouseEnter:()=>k(!0),onMouseLeave:()=>k(!1),children:[u&&!n&&e.jsx(H,{title:t.userDisplayName,children:e.jsx(G,{src:t.userPhotoURL,sx:{width:32,height:32,border:`2px solid ${R(t.userEmail)}`},children:t.userDisplayName.charAt(0)})}),e.jsxs(o,{sx:{maxWidth:"70%",minWidth:"auto",position:"relative"},children:[u&&!n&&e.jsx(i,{variant:"caption",sx:{color:R(t.userEmail),fontWeight:"bold",ml:1},children:t.userDisplayName}),e.jsxs(C,{elevation:1,sx:{p:t.type==="emoji"?1:1.5,backgroundColor:n?"primary.main":"white",color:n?"white":"text.primary",borderRadius:n?"18px 18px 6px 18px":"18px 18px 18px 6px",position:"relative",wordBreak:"break-word"},children:[t.type==="emoji"?e.jsx(i,{variant:"h4",sx:{lineHeight:1},children:t.content}):e.jsx(i,{variant:"body2",children:t.content}),e.jsx(i,{variant:"caption",sx:{display:"block",textAlign:n?"right":"left",mt:.5,opacity:.7,fontSize:"0.7rem"},children:q(t.createdAt)})]}),t.reactions&&t.reactions.length>0&&e.jsx(o,{sx:{display:"flex",gap:.5,mt:1,flexWrap:"wrap"},children:(()=>{const c={};return t.reactions.forEach(d=>{c[d.emoji]||(c[d.emoji]=[]),c[d.emoji].push(d)}),Object.entries(c).map(([d,x])=>e.jsx(H,{title:`${x.map(h=>h.userDisplayName).join(", ")}이(가) ${d} 반응했습니다`,children:e.jsx(v,{label:`${d} ${x.length}`,size:"small",onClick:()=>l(t.id,d),sx:{fontSize:"0.7rem",height:20,backgroundColor:x.some(h=>h.userEmail===p.email)?"primary.light":"grey.100",color:x.some(h=>h.userEmail===p.email)?"primary.contrastText":"text.primary",cursor:"pointer","&:hover":{backgroundColor:x.some(h=>h.userEmail===p.email)?"primary.main":"grey.200"}}})},d))})()}),M&&e.jsxs(o,{sx:{position:"absolute",top:-45,[n?"right":"left"]:0,display:"flex",gap:.5,backgroundColor:"white",borderRadius:"20px",border:"1px solid rgba(0,0,0,0.1)",boxShadow:"0 4px 12px rgba(0,0,0,0.15)",p:.5,zIndex:10,"&::before":{content:'""',position:"absolute",bottom:-8,[n?"right":"left"]:16,width:0,height:0,borderLeft:"8px solid transparent",borderRight:"8px solid transparent",borderTop:"8px solid white"},"&::after":{content:'""',position:"absolute",bottom:-9,[n?"right":"left"]:16,width:0,height:0,borderLeft:"8px solid transparent",borderRight:"8px solid transparent",borderTop:"8px solid rgba(0,0,0,0.1)",zIndex:-1}},children:[["👍","❤️","😂","😮"].map(c=>e.jsx(f,{size:"small",onClick:()=>l(t.id,c),sx:{fontSize:"1rem",width:32,height:32,backgroundColor:"transparent","&:hover":{backgroundColor:"rgba(25, 118, 210, 0.08)",transform:"scale(1.1)"},transition:"all 0.2s ease"},children:c},c)),n&&e.jsx(f,{size:"small",onClick:()=>b(t.id),sx:{width:32,height:32,color:"error.main",backgroundColor:"transparent","&:hover":{backgroundColor:"rgba(244, 67, 54, 0.08)",transform:"scale(1.1)"},transition:"all 0.2s ease"},children:e.jsx(xe,{fontSize:"small"})})]})]})]})},Re=()=>{const[t,p]=a.useState(null),[n,b]=a.useState(!0);return a.useEffect(()=>{const l=ke(u=>{p(u),b(!1)});return()=>l()},[]),n?e.jsxs(o,{sx:{height:"100vh",display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column",gap:2},children:[e.jsx(he,{size:40}),e.jsx(i,{variant:"body2",color:"text.secondary",children:"채팅방을 불러오는 중..."})]}):t?e.jsx(o,{sx:{height:"100vh",display:"flex",flexDirection:"column"},children:e.jsx(Se,{user:t})}):e.jsx(o,{sx:{p:3,textAlign:"center"},children:e.jsxs(J,{severity:"info",sx:{borderRadius:2,maxWidth:400,mx:"auto"},children:[e.jsx(i,{variant:"h6",gutterBottom:!0,children:"💬 데일리 미니채팅"}),e.jsx(i,{variant:"body2",children:"실시간 채팅을 사용하려면 로그인이 필요합니다."})]})})};export{Re as default};
